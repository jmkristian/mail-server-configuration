(function(b){b.fn.tagedit=function(c){function q(){var a='<ul class="tagedit-list '+c.additionalListClass+'">';e.each(function(r){var f=b(this).attr("name").match(u);if(f&&(4==f.length&&(!1==c.deleteEmptyItems||0<b(this).val().length))&&0<f[1].length)f="undefined"!=typeof f[2]?f[2]:"",r="tagedit-"+h+"-"+(f||r),a+='<li class="tagedit-listelement tagedit-listelement-old" aria-labelledby="'+r+'">',a+='<span dir="'+c.direction+'" id="'+r+'">'+b(this).val()+"</span>",a+='<input type="hidden" name="'+h+
"["+f+']" value="'+b(this).val()+'" />',c.allowDelete&&(a+='<a class="tagedit-close" title="'+c.texts.removeLinkTitle+'" aria-label="'+c.texts.removeLinkTitle+" "+b(this).val()+'">x</a>'),a+="</li>"});e.last().after(a);var g=e.last().next();e.remove();e=g;0<c.deletedPostfix.length&&e.find('input[name$="'+c.deletedPostfix+']"]').each(function(){n(b(this).parent())});a='<li class="tagedit-listelement tagedit-listelement-new">';c.allowAdd&&(a+='<input type="text" name="'+h+'[]" value="" id="tagedit-input" disabled="disabled" class="tagedit-input-disabled" dir="'+
c.direction+'"/>');a+="</li>";a+="</ul>";e.append(a).attr("tabindex",c.tabindex).find("#tagedit-input").attr("tabindex",c.tabindex).each(function(){b(this).autoGrowInput({comfortZone:15,minWidth:15,maxWidth:2E4});b(this).bind("transformToTag",function(r,f){var g="undefined"!=typeof f&&(0<f.length||0<f),d=!0==g||c.autocompleteOptions.noCheck?!1:!0,d=s(b(this).val(),d);if(!0===d[0]||!1===d[0]&&"string"==typeof d[1])if(!1==g&&"string"==typeof d[1]&&(g=!0,f=d[1]),!0==c.allowAdd||g)d="tagedit-"+h+"-"+
f,a='<li class="tagedit-listelement tagedit-listelement-old" aria-labelledby="'+d+'">',a+='<span dir="'+c.direction+'" id="'+d+'">'+b(this).val()+"</span>",a+='<input type="hidden" name="'+(g?h+"["+f+c.addedPostfix+"]":h+"[]")+'" value="'+b(this).val()+'" />',a+='<a class="tagedit-close" title="'+c.texts.removeLinkTitle+'" aria-label="'+c.texts.removeLinkTitle+" "+b(this).val()+'">x</a>',a+="</li>",b(this).parent().before(a);b(this).val("");c.autocompleteOptions.source&&b(this).is(":ui-autocomplete")&&
b(this).autocomplete("close")}).keydown(function(a){var f=0<a.keyCode?a.keyCode:a.which;switch(f){case 46:if(!m)break;case 8:if(m)return m.fadeOut(c.animSpeed,function(){b(this).remove()}),p(),a.preventDefault(),!1;if(0==b(this).val().length){var g=e.find("li.tagedit-listelement-old").last();g.fadeOut(c.animSpeed,function(){g.remove()});a.preventDefault();return!1}break;case 9:if(0<b(this).val().length&&0==b("ul.ui-autocomplete #ui-active-menuitem").length)return b(this).trigger("transformToTag"),
a.preventDefault(),!1;break;case 37:case 39:if(0==b(this).val().length){var f=37==f?-1:1,d=e.find("li.tagedit-listelement-old");x=d.length;next=0;d.each(function(c,a){if(b(a).hasClass("tagedit-listelement-focus"))return x=c,!0});p();next=Math.max(0,x+f);d.get(next)&&(m=d.eq(next).addClass("tagedit-listelement-focus"),b(this).attr("aria-activedescendant",m.attr("aria-labelledby")),!1!=c.autocompleteOptions.source&&b(this).autocomplete("close").autocomplete("disable"));a.preventDefault();return!1}break;
default:if(null!==m)return a.preventDefault(),a.bubble=!1}return!0}).keypress(function(a){if(-1<b.inArray(0<a.keyCode?a.keyCode:a.which,c.breakKeyCodes))return 0<b(this).val().length&&0==b("ul.ui-autocomplete #ui-active-menuitem").length&&b(this).trigger("transformToTag"),a.preventDefault(),!1;0<b(this).val().length&&p();return!0}).bind("paste",function(c){var a=b(this);"paste"==c.type&&setTimeout(function(){a.trigger("transformToTag")},1)}).blur(function(){if(0==b(this).val().length)b(this).attr("disabled",
"disabled").addClass("tagedit-input-disabled");else{var a=b(this);b(this).data("blurtimer",window.setTimeout(function(){a.val("")},500))}p();c.tabindex&&e.attr("tabindex",c.tabindex)}).focus(function(){window.clearTimeout(b(this).data("blurtimer"));e.attr("tabindex","-1")});!1!=c.autocompleteOptions.source&&b(this).autocomplete(c.autocompleteOptions)}).end().click(function(a){switch(a.target.tagName){case "A":b(a.target).parent().fadeOut(c.animSpeed,function(){b(a.target).parent().remove();e.find("#tagedit-input").focus()});
break;case "INPUT":case "SPAN":case "LI":if(!1==b(a.target).hasClass("tagedit-listelement-deleted")&&!1==b(a.target).parent("li").hasClass("tagedit-listelement-deleted"))return l(a);default:b(this).find("#tagedit-input").removeAttr("disabled").removeClass("tagedit-input-disabled").focus()}return!1}).focus(function(a){b(this).click()})}function p(){m&&(!1!=c.autocompleteOptions.source&&e.find("#tagedit-input").autocomplete("enable"),m.removeClass("tagedit-listelement-focus"),m=null,e.find("#tagedit-input").removeAttr("aria-activedescendant"))}
function l(a){if(!1!=c.allowEdit){a="SPAN"==a.target.tagName?b(a.target).parent():b(a.target);var g=null;a.bind("finishEdit",function(a,c){window.clearTimeout(g);var d=b(this).find(":text"),e=s(d.val(),!0);if(0<d.val().length&&("undefined"==typeof c||!1===c)&&!0==e[0])b(this).find(":hidden").val(d.val()),b(this).find("span").html(d.val());d.remove();b(this).find("a.tagedit-save, a.tagedit-break, a.tagedit-delete").remove();b(this).removeClass("tagedit-listelement-edit").unbind("finishEdit");return!1});
var e=a.find(":hidden");html='<input type="text" name="tmpinput" autocomplete="off" value="'+e.val()+'" class="tagedit-edit-input" dir="'+c.direction+'"/>';html+='<a class="tagedit-save" title="'+c.texts.saveEditLinkTitle+'">o</a>';html+='<a class="tagedit-break" title="'+c.texts.breakEditLinkTitle+'">x</a>';!0==c.allowDelete&&(0<a.find(":hidden").length&&"undefined"!=typeof a.find(":hidden").attr("name").match(u)[3])&&(html+='<a class="tagedit-delete" title="'+c.texts.deleteLinkTitle+'">d</a>');
e.after(html);a.addClass("tagedit-listelement-edit").find("a.tagedit-save").click(function(){b(this).parent().trigger("finishEdit");return!1}).end().find("a.tagedit-break").click(function(){b(this).parent().trigger("finishEdit",[!0]);return!1}).end().find("a.tagedit-delete").click(function(){window.clearTimeout(g);if(confirm(c.texts.deleteConfirmation)){var a=t(b(this).parent());!a&&confirm(c.texts.forceDeleteConfirmation)&&n(b(this).parent());a&&n(b(this).parent())}b(this).parent().find(":text").trigger("finishEdit",
[!0]);return!1}).end().find(":text").focus().autoGrowInput({comfortZone:10,minWidth:15,maxWidth:2E4}).keypress(function(a){switch(a.keyCode){case 13:return a.preventDefault(),b(this).parent().trigger("finishEdit"),!1;case 27:return a.preventDefault(),b(this).parent().trigger("finishEdit",[!0]),!1}return!0}).blur(function(){var a=b(this);g=window.setTimeout(function(){a.parent().trigger("finishEdit",[!0])},500)})}}function t(a){if(null===c.checkToDeleteURL)return!1;a=a.find("input:hidden").attr("name").match(/\d/);
var g=!1;b.ajax({async:!1,url:c.checkToDeleteURL,dataType:"json",type:"POST",data:{tagId:a},complete:function(a,c){var e=b.parseJSON(a.responseText);!0===e.success&&(g=e.allowDelete)}});return g}function n(a){a.trigger("finishEdit",[!0]).addClass("tagedit-listelement-deleted").attr("title",c.deletedElementTitle);a.find(":hidden").each(function(){var a=RegExp("("+c.addedPostfix+"|"+c.deletedPostfix+")?]"),a=b(this).attr("name").replace(a,c.deletedPostfix+"]");b(this).attr("name",a)})}function s(a,
g){g="undefined"==typeof g?!1:g;var s=null,f=!0==c.checkNewEntriesCaseSensitive?a:a.toLowerCase(),h=!0;e.find("li.tagedit-listelement-old input:hidden").each(function(){if((!0==c.checkNewEntriesCaseSensitive?b(this).val():b(this).val().toLowerCase())==f)h=!1});if(!0==h&&!0==g&&!1!=c.autocompleteOptions.source){var d=[];if(b.isArray(c.autocompleteOptions.source))d=c.autocompleteOptions.source;else if(b.isFunction(c.autocompleteOptions.source))c.autocompleteOptions.source({term:a},function(a){d=a});
else if("string"===typeof c.autocompleteOptions.source){var k=c.autocompleteOptions.source,k=k.match(/\?/)?k+"&":k+"?";b.ajax({async:!1,url:k+("term="+a),dataType:"json",complete:function(a,c){d=b.parseJSON(a.responseText)}})}for(k=0;k<d.length;k++){var l=d[k].label?d[k].label:d[k];if((!0==c.checkNewEntriesCaseSensitive?l:l.toLowerCase())==f){h=!1;s="string"==typeof d[k]?k:d[k].id;break}}}return[h,s]}c=b.extend(!0,{autocompleteURL:null,checkToDeleteURL:null,deletedPostfix:"-d",addedPostfix:"-a",additionalListClass:"",
allowEdit:!0,allowDelete:!0,allowAdd:!0,direction:"ltr",animSpeed:500,autocompleteOptions:{select:function(a,c){b(this).val(c.item.value).trigger("transformToTag",[c.item.id]);return!1}},breakKeyCodes:[13,44],checkNewEntriesCaseSensitive:!1,texts:{removeLinkTitle:"Remove from list.",saveEditLinkTitle:"Save changes.",deleteLinkTitle:"Delete this tag from database.",deleteConfirmation:"Are you sure to delete this entry?",deletedElementTitle:"This Element will be deleted.",breakEditLinkTitle:"Cancel",
forceDeleteConfirmation:"There are more records using this tag, are you sure do you want to remove it?"},tabindex:!1},c||{});if(0!=this.length){c.autocompleteURL&&(c.autocompleteOptions.source=c.autocompleteURL);var v=this.attr("dir");v&&0<v.length&&(c.direction=this.attr("dir"));var e=this,m=null,u=RegExp("^(.*)\\[([0-9]*?("+c.deletedPostfix+"|"+c.addedPostfix+")?)?]$","i"),h=e.eq(0).attr("name").match(u);if(h&&4==h.length){var h=h[1],w;if(!c.tabindex&&(w=e.eq(0).attr("tabindex")))c.tabindex=w;q()}else alert("elementname dows not match the expected format (regexp: "+
u+")")}}})(jQuery);
(function(b){b.fn.autoGrowInput=function(c){c=b.extend({maxWidth:1E3,minWidth:0,comfortZone:70},c);this.filter("input:text").each(function(){var q=c.minWidth||b(this).width(),p="",l=b(this),t=b("<tester/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:l.css("fontSize"),fontFamily:l.css("fontFamily"),fontWeight:l.css("fontWeight"),letterSpacing:l.css("letterSpacing"),whiteSpace:"nowrap"}),n=function(){if(p!==(p=l.val())){var b=p.replace(/&/g,"&amp;").replace(/\s/g,"&nbsp;").replace(/</g,
"&lt;").replace(/>/g,"&gt;");t.html(b);var b=t.width(),b=b+c.comfortZone>=q?b+c.comfortZone:q,n=l.width();(b<n&&b>=q||b>q&&b<c.maxWidth)&&l.width(b)}};t.insertAfter(l);b(this).bind("keyup keydown blur update",n);n()});return this}})(jQuery);
